# Development Dockerfile for Next.js application
FROM node:20-alpine

RUN apk add --no-cache libc6-compat python3 make g++

# Enable Corepack for Yarn 3.2.3
RUN corepack enable

WORKDIR /app

# Copy entire scaffold directory (including .yarn for Yarn 3.2.3)
# Excluding node_modules and cache via .dockerignore
COPY scaffold ./scaffold

# Install dependencies
WORKDIR /app/scaffold
ENV YARN_ENABLE_IMMUTABLE_INSTALLS=false
RUN yarn install

WORKDIR /app/scaffold/packages/nextjs

EXPOSE 3000

ENV PORT=3000
ENV HOSTNAME="0.0.0.0"

# Create entrypoint script to fix permissions
RUN echo '#!/bin/sh' > /entrypoint.sh && \
    echo 'chmod -R a+rw /app/scaffold 2>/dev/null || true' >> /entrypoint.sh && \
    echo 'cd /app/scaffold/packages/nextjs' >> /entrypoint.sh && \
    echo 'exec "$@"' >> /entrypoint.sh && \
    chmod +x /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]
CMD ["yarn", "dev"]

