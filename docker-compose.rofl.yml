# Docker Compose for ROFL integration testing
# This file is referenced in rofl.yaml for ROFL container deployment

services:
  # Anvil - Local blockchain for testing
  anvil:
    image: ghcr.io/foundry-rs/foundry:latest
    entrypoint: []
    command: ["anvil", "--host", "0.0.0.0", "--port", "8545", "--block-time", "2"]
    ports:
      - "8545:8545"
    volumes:
      - anvil-data:/root/.foundry
    networks:
      - shayd-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "cast", "chain-id", "--rpc-url", "http://localhost:8545"]
      interval: 2s
      timeout: 5s
      retries: 10
      start_period: 5s

  # Resolver Service - Combined ROFL TEE hashing and liquidation execution
  resolver:
    build:
      context: ./resolver
      dockerfile: Dockerfile
    ports:
      - "3001:3001"  # Resolver API port (includes ROFL TEE /hash endpoint)
    environment:
      - RPC_URL=http://anvil:8545
      - POOL_MANAGER_ADDRESS=${POOL_MANAGER_ADDRESS:-}
      - PRIVATE_KEY=${RESOLVER_PRIVATE_KEY:-}
      - LIQUIDATION_THRESHOLD=1000000000000000000
      - MONITORING_INTERVAL=30000
    volumes:
      - ./resolver:/app:z
      - ./scaffold:/app/scaffold:z
      - /app/node_modules
    networks:
      - shayd-network
    restart: unless-stopped
    depends_on:
      - anvil

  # Integration Test Runner
  integration-tests:
    build:
      context: .
      dockerfile: Dockerfile.integration
    environment:
      - RPC_URL=http://anvil:8545
      - RESOLVER_URL=http://resolver:3001
      - POOL_MANAGER_ADDRESS=${POOL_MANAGER_ADDRESS:-}
      - PRIVATE_KEY=${PRIVATE_KEY:-0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80}
      - FOUNDRY_DISABLE_NIGHTLY_WARNING=1
    volumes:
      - ./scaffold:/app/scaffold:z
      - ./tests:/app/tests:z
      - ./resolver:/app/resolver:z
    networks:
      - shayd-network
    depends_on:
      anvil:
        condition: service_healthy
      resolver:
        condition: service_started
    # Deploy contracts using Scaffold's deploy script, then run tests
    # Use timeout to prevent hanging, skip solc download if rate limited
    command: /bin/sh -c "cd /app/scaffold/packages/foundry && mkdir -p deployments && export FOUNDRY_DISABLE_NIGHTLY_WARNING=1 && timeout 120 forge script script/Deploy.s.sol:DeployScript --rpc-url http://anvil:8545 --broadcast --skip-simulation 2>&1 || echo 'Deployment failed or skipped' && sleep 2 && timeout 120 forge script script/DeployBundledVault.s.sol:DeployBundledVault --rpc-url http://anvil:8545 --broadcast --skip-simulation 2>&1 || echo 'BundledVault deployment failed or skipped' && cd /app && npx jest --config jest.config.js tests/integration"

networks:
  shayd-network:
    driver: bridge

volumes:
  anvil-data:

